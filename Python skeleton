import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

# Load AIS data (e.g., from Global Fishing Watch: time, lat, lon, speed_over_ground)
data = pd.read_csv('maritime_ais_data.csv')
t = data['time'].values
post_t = t - t[0]

num_branches = 50
np.random.seed(42)
alphas = np.random.dirichlet(np.ones(num_branches))

P_d = data[['lat', 'lon', 'sog']].iloc[0].values  # SOG as "alt" analog

S_c = np.zeros((3, len(t)), dtype=complex)
epsilon = 1.0

for i in range(num_branches):
    alpha = alphas[i]
    pert = 0.15 * np.random.randn(3)  # Maritime perts (currents)
    
    lat_i = data['lat'].values + pert[0] * (1 + 0.03 * post_t)
    lon_i = data['lon'].values + pert[1] * (1 + 0.03 * post_t)
    sog_i = data['sog'].values + pert[2] * (1 + 0.03 * post_t)
    
    V_complex = np.array([
        lat_i + 1j * (-0.25 * lon_i),
        lon_i + 1j * (-0.25 * lat_i),
        sog_i + 1j * (0.08 * np.sin(0.08 * post_t))  # Speed divergence
    ])
    
    # "Tumble" for course changes (e.g., at waypoints)
    tumble = np.where(post_t >= 10, 1.0, 0.0)  # Divergence at route change
    roll = 0.01 * post_t + 0.08 * np.sin(0.4 * post_t) * tumble  # Heading wobble
    pitch = 0.015 * post_t + 0.1 * np.cos(0.5 * post_t) * tumble
    yaw = 0.005 * post_t + 0.15 * np.sin(0.6 * post_t) * tumble
    
    Theta_complex = np.array([
        roll + 1j * 0.03 * np.sin(0.3 * post_t),
        pitch + 1j * 0.03 * np.cos(0.4 * post_t),
        yaw + 1j * 0.03 * np.sin(0.5 * post_t)
    ])
    
    num = P_d[:, np.newaxis] + V_complex
    den = theta_d[:, np.newaxis] + Theta_complex + epsilon
    S_c += alpha * (num / den)

pos_super = np.real(S_c)

# Plot (2D for maritime paths)
fig, ax = plt.subplots(figsize=(12,8))
ax.plot(pos_super[1], pos_super[0], 'b-', lw=3, label='Superposed Path')
ax.set_xlabel('Lon')
ax.set_ylabel('Lat')
ax.legend()
plt.savefig('maritime_superposition.png')
print("Saved 'maritime_superposition.png'")
