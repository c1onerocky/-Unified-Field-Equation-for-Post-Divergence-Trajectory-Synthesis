import numpy as np
import matplotlib.pyplot as plt
import pandas as pd  # For loading flight data

# Load example flight data (replace with OpenSky CSV: columns time, lat, lon, alt)
data = pd.read_csv('flight_path_data.csv')  # e.g., from OpenSky
t = data['time'].values
post_t = t - t[0]  # Normalize to divergence point td=0

num_branches = 50
np.random.seed(42)
alphas = np.random.dirichlet(np.ones(num_branches))

# Nominal path from data
P_d = data[['lat', 'lon', 'alt']].iloc[0].values  # Divergence point

S_c = np.zeros((3, len(t)), dtype=complex)
epsilon = 1.0

for i in range(num_branches):
    alpha = alphas[i]
    pert = 0.2 * np.random.randn(3)  # Path perturbations (winds/delays)
    
    # Branch paths (add noise to nominal)
    lat_i = data['lat'].values + pert[0] * (1 + 0.04 * post_t)
    lon_i = data['lon'].values + pert[1] * (1 + 0.04 * post_t)
    alt_i = data['alt'].values + pert[2] * (1 + 0.04 * post_t)
    
    # Complexify (imaginaries for sensitivity)
    V_complex = np.array([
        lat_i + 1j * (-0.3 * lon_i),
        lon_i + 1j * (-0.3 * lat_i),
        alt_i + 1j * (0.1 * np.sin(0.1 * post_t))
    ])
    
    # Orientation (e.g., heading/roll perturbations)
    tumble_mask = (post_t >= 3.0)  # "Divergence" at delay point
    roll = 0.015 * post_t + 0.1 * np.sin(0.5 * post_t) * tumble_mask
    pitch = 0.02 * post_t + 0.15 * np.cos(0.6 * post_t) * tumble_mask
    yaw = 0.01 * post_t + 0.2 * np.sin(0.7 * post_t) * tumble_mask
    
    Theta_complex = np.array([
        roll + 1j * 0.04 * np.sin(0.4 * post_t),
        pitch + 1j * 0.04 * np.cos(0.5 * post_t),
        yaw + 1j * 0.04 * np.sin(0.6 * post_t)
    ])
    
    num = P_d[:, np.newaxis] + V_complex
    den = theta_d[:, np.newaxis] + Theta_complex + epsilon
    S_c += alpha * (num / den)

pos_super = np.real(S_c)

# Plot (3D for flight paths)
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')
ax.plot(pos_super[1], pos_super[0], pos_super[2], 'b-', lw=3, label='Superposed Path')
ax.set_xlabel('Lon')
ax.set_ylabel('Lat')
ax.set_zlabel('Alt (kft)')
ax.legend()
plt.savefig('flight_superposition.png')
print("Saved 'flight_superposition.png'")

# Stats (generalize for any flight data)
apogee_idx = np.argmax(pos_super[2])
print(f"Apogee: {pos_super[2][apogee_idx]:.1f} kft at t={t[apogee_idx]:.0f}s")
